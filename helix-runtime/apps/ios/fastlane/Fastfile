default_platform(:ios)

platform :ios do
  desc "Build and run tests"
  lane :test do
    build_app(
      workspace: "OpenClaw.xcworkspace",
      scheme: "OpenClaw",
      configuration: "Debug",
      destination: "generic/platform=iOS Simulator",
      skip_package_ipa: true,
      skip_install: true,
      derived_data_path: "build"
    )

    run_tests(
      workspace: "OpenClaw.xcworkspace",
      scheme: "OpenClaw",
      configuration: "Debug",
      destination: "generic/platform=iOS Simulator",
      derived_data_path: "build"
    )

    puts("✅ Tests passed")
  end

  desc "Build for device"
  lane :build_device do |options|
    build_app(
      workspace: "OpenClaw.xcworkspace",
      scheme: "OpenClaw",
      configuration: "Release",
      sdk: "iphoneos",
      derived_data_path: "build",
      destination: "generic/platform=iOS",
      export_xcargs: "-allowProvisioningUpdates",
      skip_package_ipa: true,
      skip_install: false
    )

    puts("✅ Device build complete")
  end

  desc "Generate screenshots"
  lane :screenshots do
    capture_screenshots(
      workspace: "OpenClaw.xcworkspace",
      scheme: "OpenClaw",
      configuration: "Debug",
      clear_previous_screenshots: true,
      output_directory: "fastlane/screenshots",
      clear_simulator_cache: true
    )

    puts("✅ Screenshots captured")
  end

  desc "Build archive for TestFlight"
  lane :build_archive do |options|
    version = options[:version] || get_version_number(xcodeproj: "OpenClaw.xcodeproj")
    build_number = options[:build_number] || number_of_commits().to_s

    increment_version_number(
      version_number: version,
      xcodeproj: "OpenClaw.xcodeproj"
    )

    increment_build_number(
      build_number: build_number,
      xcodeproj: "OpenClaw.xcodeproj"
    )

    build_app(
      workspace: "OpenClaw.xcworkspace",
      scheme: "OpenClaw",
      configuration: "Release",
      sdk: "iphoneos",
      derived_data_path: "build",
      destination: "generic/platform=iOS",
      export_xcargs: "-allowProvisioningUpdates",
      skip_package_ipa: false,
      include_bitcode: true,
      include_symbols: true,
      archive_path: "build/OpenClaw.xcarchive",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "ai.openclaw.ios" => "OpenClaw App Store"
        },
        signingStyle: "automatic",
        stripSwiftSymbols: true,
        thinning: "<none>"
      }
    )

    puts("✅ Archive built")
  end

  desc "Upload to TestFlight"
  lane :beta do |options|
    build_archive(
      version: options[:version],
      build_number: options[:build_number]
    )

    upload_to_testflight(
      ipa: "build/OpenClaw.ipa",
      skip_submission: true,
      skip_waiting_for_build_processing: false,
      distribute_external: false,
      notify_external_testers: false
    )

    puts("✅ Uploaded to TestFlight")
  end

  desc "Submit for App Store review"
  lane :release do |options|
    build_archive(
      version: options[:version],
      build_number: options[:build_number]
    )

    upload_to_app_store(
      ipa: "build/OpenClaw.ipa",
      skip_metadata: false,
      skip_screenshots: false,
      skip_binary_upload: false
    )

    puts("✅ Submitted for App Store review")
  end

  error do |lane, exception|
    UI.error("Error in lane: #{exception.message}")
  end
end
