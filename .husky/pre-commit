#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Helix Security Pre-commit Hook
# Prevents credentials from being committed to git

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check for common credential patterns in staged files
echo "üîç Scanning for credentials..."

# Credential patterns to detect
CREDENTIALS_FOUND=0

# Check for AWS keys
if git diff --cached | grep -q "AKIA[0-9A-Z]\{16\}"; then
    echo "${RED}‚ùå AWS Access Key detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for private keys
if git diff --cached | grep -q "-----BEGIN.*PRIVATE KEY-----"; then
    echo "${RED}‚ùå Private key detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for API keys patterns
if git diff --cached | grep -qE "(sk_live_|sk_test_|pk_live_|pk_test_)"; then
    echo "${RED}‚ùå Stripe API key detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for GitHub tokens
if git diff --cached | grep -qE "ghp_[A-Za-z0-9_]{36}"; then
    echo "${RED}‚ùå GitHub Personal Access Token detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for Discord webhooks
if git diff --cached | grep -q "https://discord.com/api/webhooks/"; then
    echo "${RED}‚ùå Discord webhook URL detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for 1Password references in .env files
if git diff --cached -- '*.env' | grep -qE "DISCORD_WEBHOOK|API_KEY|SECRET"; then
    echo "${RED}‚ùå Credentials in .env file detected!${NC}"
    CREDENTIALS_FOUND=1
fi

# Check for JWT-like tokens
if git diff --cached | grep -qE "eyJ[A-Za-z0-9_-]{20,}"; then
    echo "${YELLOW}‚ö†Ô∏è  JWT-like token detected. Please verify this is not a secret.${NC}"
fi

if [ $CREDENTIALS_FOUND -eq 1 ]; then
    echo ""
    echo "${RED}üö´ COMMIT BLOCKED: Credentials detected!${NC}"
    echo ""
    echo "To fix:"
    echo "  1. Remove credentials from files"
    echo "  2. Use 1Password for secrets (see docs/PRODUCTION_SECRETS_SETUP.md)"
    echo "  3. Stage cleaned files: git add <file>"
    echo "  4. Try commit again"
    echo ""
    exit 1
fi

# Run lint-staged (formatting and linting)
echo "‚úì No credentials detected"
echo "üìù Running linters..."
npx lint-staged

# Check exit code
if [ $? -eq 0 ]; then
    echo "${GREEN}‚úì Pre-commit checks passed${NC}"
    exit 0
else
    echo "${RED}‚úó Pre-commit checks failed${NC}"
    exit 1
fi
