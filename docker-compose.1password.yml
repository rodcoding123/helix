# Docker Compose - Helix with 1Password Integration
#
# Local Development: Uses .env fallback
#   docker-compose -f docker-compose.1password.yml up
#
# Production: Uses 1Password service account
#   export OP_SERVICE_ACCOUNT_TOKEN=<your-token>
#   docker-compose -f docker-compose.1password.yml up

version: '3.8'

services:
  helix:
    build:
      context: .
      dockerfile: openclaw-helix/Dockerfile.1password
    container_name: helix-main

    # Environment variables
    environment:
      # 1Password Configuration
      HELIX_SECRETS_SOURCE: '${HELIX_SECRETS_SOURCE:-env}'  # Use 'env' for dev, '1password' for prod
      OP_SERVICE_ACCOUNT_TOKEN: '${OP_SERVICE_ACCOUNT_TOKEN:-}'  # Set in production

      # Node configuration
      NODE_ENV: '${NODE_ENV:-production}'
      NODE_OPTIONS: '--enable-source-maps'

      # Logging configuration
      LOG_LEVEL: '${LOG_LEVEL:-info}'

      # Fallback secrets (dev only - NOT for production!)
      # These are loaded from .env if 1Password is not available
      SUPABASE_SERVICE_ROLE: '${SUPABASE_SERVICE_ROLE:-}'
      SUPABASE_ANON_KEY: '${SUPABASE_ANON_KEY:-}'
      STRIPE_SECRET_KEY: '${STRIPE_SECRET_KEY:-}'
      STRIPE_PUBLISHABLE_KEY: '${STRIPE_PUBLISHABLE_KEY:-}'
      DEEPSEEK_API_KEY: '${DEEPSEEK_API_KEY:-}'
      GEMINI_API_KEY: '${GEMINI_API_KEY:-}'
      DISCORD_WEBHOOK_COMMANDS: '${DISCORD_WEBHOOK_COMMANDS:-}'
      DISCORD_WEBHOOK_API: '${DISCORD_WEBHOOK_API:-}'
      DISCORD_WEBHOOK_HEARTBEAT: '${DISCORD_WEBHOOK_HEARTBEAT:-}'
      DISCORD_WEBHOOK_ALERTS: '${DISCORD_WEBHOOK_ALERTS:-}'
      DISCORD_WEBHOOK_CONSCIOUSNESS: '${DISCORD_WEBHOOK_CONSCIOUSNESS:-}'
      DISCORD_WEBHOOK_FILE_CHANGES: '${DISCORD_WEBHOOK_FILE_CHANGES:-}'
      DISCORD_WEBHOOK_HASH_CHAIN: '${DISCORD_WEBHOOK_HASH_CHAIN:-}'

    # Port mapping
    ports:
      - '3000:3000'  # API port
      - '5173:5173'  # Dev server (if running)

    # Volume mounts
    volumes:
      # Development: Mount source code for live reload (optional)
      - ./src:/app/src
      - ./web/src:/app/web/src

      # 1Password session cache (helps with repeated auth)
      - helix-op-cache:/home/node/.op-session

      # Logs directory
      - ./logs:/app/logs

    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Restart policy
    restart: unless-stopped

volumes:
  helix-op-cache:
    driver: local

# Production variant (without source mounts)
# Usage: docker-compose -f docker-compose.1password.yml -f docker-compose.prod.yml up
