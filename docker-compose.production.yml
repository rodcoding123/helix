# HELIX PRODUCTION DOCKER COMPOSE
# Security-hardened deployment configuration
#
# Usage:
#   docker-compose -f docker-compose.production.yml up -d
#
# Security Features:
# - Non-root user
# - Read-only root filesystem
# - All capabilities dropped
# - No new privileges
# - Seccomp profile
# - Resource limits
# - Network isolation
# - Health checks

version: '3.8'

services:
  helix:
    build:
      context: .
      dockerfile: Dockerfile.production
    image: helix:production
    container_name: helix-production
    restart: unless-stopped

    # Security configurations
    security_opt:
      - no-new-privileges:true
      - seccomp=./seccomp-helix.json
    cap_drop:
      - ALL
    read_only: true

    # Writable tmpfs for temporary files
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
      - /var/tmp:rw,noexec,nosuid,size=32m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 256M

    # Environment variables (use secrets in production)
    environment:
      - NODE_ENV=production
      - HELIX_FAIL_CLOSED=true
      - HELIX_SECURITY_VALIDATION=true
      # Discord webhooks (required)
      - DISCORD_WEBHOOK_COMMANDS=${DISCORD_WEBHOOK_COMMANDS}
      - DISCORD_WEBHOOK_HASH_CHAIN=${DISCORD_WEBHOOK_HASH_CHAIN}
      - DISCORD_WEBHOOK_ALERTS=${DISCORD_WEBHOOK_ALERTS}
      # Optional webhooks
      - DISCORD_WEBHOOK_API=${DISCORD_WEBHOOK_API:-}
      - DISCORD_WEBHOOK_FILE_CHANGES=${DISCORD_WEBHOOK_FILE_CHANGES:-}
      - DISCORD_WEBHOOK_CONSCIOUSNESS=${DISCORD_WEBHOOK_CONSCIOUSNESS:-}
      - DISCORD_WEBHOOK_HEARTBEAT=${DISCORD_WEBHOOK_HEARTBEAT:-}
      # Anthropic API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Ports
    ports:
      - "3000:3000"

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Network isolation
    networks:
      - helix-internal

    # Volume mounts (minimal, read-only where possible)
    volumes:
      # Persistent hash chain storage
      - helix-data:/app/data:rw
      # Read-only psychological context
      - ./soul:/app/soul:ro
      - ./psychology:/app/psychology:ro
      - ./identity:/app/identity:ro
      - ./purpose:/app/purpose:ro
      - ./transformation:/app/transformation:ro

networks:
  helix-internal:
    driver: bridge
    internal: true  # No external network access
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  helix-data:
    driver: local

# For external API access, use a reverse proxy:
#
# nginx:
#   image: nginx:alpine
#   ports:
#     - "443:443"
#   volumes:
#     - ./nginx.conf:/etc/nginx/nginx.conf:ro
#     - ./certs:/etc/nginx/certs:ro
#   networks:
#     - helix-internal
#     - external
#   depends_on:
#     - helix
